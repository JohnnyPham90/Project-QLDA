<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>QLDA - Ti·∫øn ƒë·ªô D·ª± √°n</title>
  <style>
    body { font-family: Arial; background: #f4f4f4; padding: 20px; }
    input, button { margin: 4px; padding: 6px; }
    table { border-collapse: collapse; width: 100%; background: #fff; margin-top: 20px; }
    th, td { border: 1px solid #ccc; padding: 8px; }
    th { background: #eee; }
    td.editable { cursor: pointer; }
    td input { width: 100%; border: none; padding: 4px; box-sizing: border-box; }
    .delete-btn { color: red; cursor: pointer; }
  </style>

  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-firestore-compat.js"></script>
</head>
<body>
  <h2>Qu·∫£n l√Ω ti·∫øn ƒë·ªô d·ª± √°n</h2>

  <div id="authSection">
    <input id="email" type="email" placeholder="Email">
    <input id="password" type="password" placeholder="M·∫≠t kh·∫©u">
    <button onclick="login()">ƒêƒÉng nh·∫≠p</button>
    <button onclick="signup()">ƒêƒÉng k√Ω</button>
  </div>

  <div id="appSection" style="display:none;">
    <button onclick="logout()">ƒêƒÉng xu·∫•t</button>
    <table>
      <thead>
        <tr>
          <th>T√™n d·ª± √°n</th>
          <th>C√¥ng vi·ªác</th>
          <th>Ti·∫øn ƒë·ªô</th>
          <th>B√°o c√°o k·∫øt qu·∫£</th>
          <th>ƒê√°nh gi√°</th>
          <th>V∆∞·ªõng m·∫Øc</th>
          <th>Xo√°</th>
        </tr>
      </thead>
      <tbody id="projectRows"></tbody>
    </table>
  </div>
<script>
  // Firebase config
  const firebaseConfig = {
    apiKey: "AIzaSyCawOPhgU4mp3JD1A8bNDWmIP0XHzUJlUk",
    authDomain: "project-qlda.firebaseapp.com",
    projectId: "project-qlda",
    storageBucket: "project-qlda.firebasestorage.app",
    messagingSenderId: "174135198782",
    appId: "1:174135198782:web:4cdbfe8e47209e52a2fd6f",
    measurementId: "G-TGBCRTW5LB"
  };

  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.firestore();
  let currentUser = null;
</script>
<script>
  function login() {
    const email = document.getElementById("email").value;
    const password = document.getElementById("password").value;
    auth.signInWithEmailAndPassword(email, password)
      .catch(() => alert("Sai t√†i kho·∫£n ho·∫∑c m·∫≠t kh·∫©u"));
  }

  function signup() {
    const email = document.getElementById("email").value;
    const password = document.getElementById("password").value;
    auth.createUserWithEmailAndPassword(email, password)
      .then(() => alert("ƒêƒÉng k√Ω th√†nh c√¥ng"))
      .catch(() => alert("L·ªói ƒëƒÉng k√Ω"));
  }

  function logout() {
    auth.signOut().then(() => location.reload());
  }
</script>
<script>
  auth.onAuthStateChanged(async (user) => {
    if (user) {
      currentUser = user;
      document.getElementById("authSection").style.display = "none";
      document.getElementById("appSection").style.display = "block";
      const isAdmin = user.email === "admin@qlda.com";
      const q = isAdmin
        ? db.collection("projects")
        : db.collection("projects").where("userId", "==", user.uid);
      const snap = await q.get();
      const tbody = document.getElementById("projectRows");
      tbody.innerHTML = "";
      snap.forEach(doc => tbody.appendChild(renderRow(doc.data(), doc.id)));
      tbody.appendChild(renderRow({}, null, true));
    }
  });
function renderRow(data, docId, isNew = false) {
  const tr = document.createElement("tr");
  const fields = ["name", "task", "progress", "report", "result", "issue"];
  const cells = {};

  fields.forEach((field) => {
    const td = document.createElement("td");
    td.classList.add("editable");
    td.textContent = data[field] || "";
    cells[field] = td;

    // üîí Kh√¥ng cho s·ª≠a √¥ Ti·∫øn ƒë·ªô n·∫øu kh√¥ng ph·∫£i admin
    const isAdmin = currentUser.email === "admin@qlda.com";
    if (field === "progress" && !isAdmin) {
      td.style.backgroundColor = "#eee";
      tr.appendChild(td);
      return;
    }

    // ‚¨á N·∫øu l√† "report" th√¨ t·∫°o dropdown
    if (field === "report") {
      td.onclick = () => {
        const select = document.createElement("select");
        const options = ["Ch∆∞a ho√†n th√†nh", "ƒê√£ ho√†n th√†nh"];
        options.forEach(opt => {
          const option = document.createElement("option");
          option.value = opt;
          option.text = opt;
          if (opt === data[field]) option.selected = true;
          select.appendChild(option);
        });

        td.textContent = "";
        td.appendChild(select);
        select.focus();

        select.onchange = async () => {
          const value = select.value;
          td.textContent = value;
          data[field] = value;

          // T·ª± ƒë√°nh gi√° d·ª±a v√†o Ti·∫øn ƒë·ªô + B√°o c√°o
          const auto = evaluateReportResult(data.progress, value);
          cells["result"].textContent = auto;
          data["result"] = auto;

          if (isNew && data.name && data.progress) {
            const docRef = await db.collection("projects").add({ ...data, userId: currentUser.uid });
            tr.replaceWith(renderRow({ ...data }, docRef.id));
            document.getElementById("projectRows").appendChild(renderRow({}, null, true));
          } else if (docId) {
            await db.collection("projects").doc(docId).update(data);
          }
        };
      };

      tr.appendChild(td);
      return;
    }

    // C√°c √¥ c√≤n l·∫°i
    td.onclick = () => {
      const input = document.createElement("input");
      input.value = td.textContent;
      td.textContent = "";
      td.appendChild(input);
      input.focus();

      input.onblur = async () => {
        const newValue = input.value.trim();
        td.textContent = newValue;
        data[field] = newValue;

        if (field === "progress") {
          // N·∫øu c√≥ b√°o c√°o ‚Üí ƒë√°nh gi√°
          if (data["report"]) {
            const auto = evaluateReportResult(newValue, data["report"]);
            cells["result"].textContent = auto;
            data["result"] = auto;
          }
        }

        if (isNew && data.name && data.progress) {
          const docRef = await db.collection("projects").add({ ...data, userId: currentUser.uid });
          tr.replaceWith(renderRow({ ...data }, docRef.id));
          document.getElementById("projectRows").appendChild(renderRow({}, null, true));
        } else if (docId) {
          await db.collection("projects").doc(docId).update(data);
        }
      };
    };

    tr.appendChild(td);
  });

  // N√∫t xo√°
  const deleteTd = document.createElement("td");
  if (docId) {
    deleteTd.innerHTML = "<span class='delete-btn'>üóë</span>";
    deleteTd.onclick = async () => {
      await db.collection("projects").doc(docId).delete();
      tr.remove();
    };
  }
  tr.appendChild(deleteTd);
  return tr;
}
  function evaluateReportResult(progressDateStr, reportStatus) {
  if (!progressDateStr || !reportStatus) return "";

  const today = new Date();
  const [d, m, y] = progressDateStr.split("-");
  const progressDate = new Date(`${y}-${m}-${d}`);
  today.setHours(0, 0, 0, 0);
  progressDate.setHours(0, 0, 0, 0);

  if (reportStatus === "Ch∆∞a ho√†n th√†nh") {
    return progressDate > today ? "Ph·∫•n ƒë·∫•u ho√†n th√†nh" : "Ch·∫•t l∆∞·ª£ng k√©m";
  }

  if (reportStatus === "ƒê√£ ho√†n th√†nh") {
    return progressDate > today ? "R·∫•t t·ªët" : "H∆°i ch·∫≠m";
  }

  return "";
}

</script>
 

</body>
</html>
